{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/middleware.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\n\r\nconst ROLE_HOME: Record<string, string> = {\r\n    admin: '/admin',\r\n    sdr: '/sdr',\r\n    hr: '/hr',\r\n    leadgen: '/leadgen',\r\n};\r\n\r\nconst ROLE_PREFIXES: Record<string, string[]> = {\r\n    admin: ['/admin'],\r\n    sdr: ['/sdr'],\r\n    hr: ['/hr'],\r\n    leadgen: ['/leadgen'],\r\n};\r\n\r\nconst PUBLIC_PATHS = ['/', '/login', '/forgot-password', '/reset-password'];\r\n\r\nfunction getTokenPayload(token: string): { role?: string } | null {\r\n    try {\r\n        // JWT is base64url encoded — decode payload segment (no crypto needed for role check)\r\n        const parts = token.split('.');\r\n        if (parts.length !== 3) return null;\r\n        const payload = Buffer.from(parts[1], 'base64url').toString('utf8');\r\n        return JSON.parse(payload);\r\n    } catch {\r\n        return null;\r\n    }\r\n}\r\n\r\nexport function middleware(req: NextRequest) {\r\n    const { pathname } = req.nextUrl;\r\n\r\n    // Allow public paths and Next.js internals\r\n    if (\r\n        PUBLIC_PATHS.includes(pathname) ||\r\n        pathname.startsWith('/_next') ||\r\n        pathname.startsWith('/api') ||\r\n        pathname.includes('.')\r\n    ) {\r\n        return NextResponse.next();\r\n    }\r\n\r\n    const token = req.cookies.get('insurelead_token')?.value;\r\n\r\n    // No token → redirect to login\r\n    if (!token) {\r\n        const loginUrl = req.nextUrl.clone();\r\n        loginUrl.pathname = '/login';\r\n        return NextResponse.redirect(loginUrl);\r\n    }\r\n\r\n    const payload = getTokenPayload(token);\r\n\r\n    // Malformed token → redirect to login\r\n    if (!payload?.role) {\r\n        const loginUrl = req.nextUrl.clone();\r\n        loginUrl.pathname = '/login';\r\n        return NextResponse.redirect(loginUrl);\r\n    }\r\n\r\n    const role = payload.role;\r\n    const allowedPrefixes = ROLE_PREFIXES[role] ?? [];\r\n\r\n    // Check if current path is allowed for this role\r\n    const isAllowed = allowedPrefixes.some((prefix) => pathname.startsWith(prefix));\r\n    if (!isAllowed) {\r\n        const home = req.nextUrl.clone();\r\n        home.pathname = ROLE_HOME[role] ?? '/login';\r\n        return NextResponse.redirect(home);\r\n    }\r\n\r\n    return NextResponse.next();\r\n}\r\n\r\nexport const config = {\r\n    matcher: [\r\n        /*\r\n         * Match all paths except:\r\n         * - _next/static (static files)\r\n         * - _next/image (image optimization)\r\n         * - favicon.ico\r\n         */\r\n        '/((?!_next/static|_next/image|favicon.ico).*)',\r\n    ],\r\n};\r\n"],"names":[],"mappings":";;;;;;AAuBwB;AAvBxB;AAAA;;AAEA,MAAM,YAAoC;IACtC,OAAO;IACP,KAAK;IACL,IAAI;IACJ,SAAS;AACb;AAEA,MAAM,gBAA0C;IAC5C,OAAO;QAAC;KAAS;IACjB,KAAK;QAAC;KAAO;IACb,IAAI;QAAC;KAAM;IACX,SAAS;QAAC;KAAW;AACzB;AAEA,MAAM,eAAe;IAAC;IAAK;IAAU;IAAoB;CAAkB;AAE3E,SAAS,gBAAgB,KAAa;IAClC,IAAI;QACA,sFAAsF;QACtF,MAAM,QAAQ,MAAM,KAAK,CAAC;QAC1B,IAAI,MAAM,MAAM,KAAK,GAAG,OAAO;QAC/B,MAAM,UAAU,+HAAM,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE,EAAE,aAAa,QAAQ,CAAC;QAC5D,OAAO,KAAK,KAAK,CAAC;IACtB,EAAE,OAAM;QACJ,OAAO;IACX;AACJ;AAEO,SAAS,WAAW,GAAgB;IACvC,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAI,OAAO;IAEhC,2CAA2C;IAC3C,IACI,aAAa,QAAQ,CAAC,aACtB,SAAS,UAAU,CAAC,aACpB,SAAS,UAAU,CAAC,WACpB,SAAS,QAAQ,CAAC,MACpB;QACE,OAAO,gMAAY,CAAC,IAAI;IAC5B;IAEA,MAAM,QAAQ,IAAI,OAAO,CAAC,GAAG,CAAC,qBAAqB;IAEnD,+BAA+B;IAC/B,IAAI,CAAC,OAAO;QACR,MAAM,WAAW,IAAI,OAAO,CAAC,KAAK;QAClC,SAAS,QAAQ,GAAG;QACpB,OAAO,gMAAY,CAAC,QAAQ,CAAC;IACjC;IAEA,MAAM,UAAU,gBAAgB;IAEhC,sCAAsC;IACtC,IAAI,CAAC,SAAS,MAAM;QAChB,MAAM,WAAW,IAAI,OAAO,CAAC,KAAK;QAClC,SAAS,QAAQ,GAAG;QACpB,OAAO,gMAAY,CAAC,QAAQ,CAAC;IACjC;IAEA,MAAM,OAAO,QAAQ,IAAI;IACzB,MAAM,kBAAkB,aAAa,CAAC,KAAK,IAAI,EAAE;IAEjD,iDAAiD;IACjD,MAAM,YAAY,gBAAgB,IAAI,CAAC,CAAC,SAAW,SAAS,UAAU,CAAC;IACvE,IAAI,CAAC,WAAW;QACZ,MAAM,OAAO,IAAI,OAAO,CAAC,KAAK;QAC9B,KAAK,QAAQ,GAAG,SAAS,CAAC,KAAK,IAAI;QACnC,OAAO,gMAAY,CAAC,QAAQ,CAAC;IACjC;IAEA,OAAO,gMAAY,CAAC,IAAI;AAC5B;AAEO,MAAM,SAAS;IAClB,SAAS;QACL;;;;;SAKC,GACD;KACH;AACL"}}]
}