import { NextRequest, NextResponse } from 'next/server';

const ROLE_HOME: Record<string, string> = {
    admin: '/admin',
    sdr: '/sdr',
    hr: '/hr',
    leadgen: '/leadgen',
};

const ROLE_PREFIXES: Record<string, string[]> = {
    admin: ['/admin'],
    sdr: ['/sdr'],
    hr: ['/hr'],
    leadgen: ['/leadgen'],
};

const PUBLIC_PATHS = ['/', '/login', '/forgot-password', '/reset-password'];

function getTokenPayload(token: string): { role?: string } | null {
    try {
        // JWT is base64url encoded — decode payload segment (no crypto needed for role check)
        const parts = token.split('.');
        if (parts.length !== 3) return null;
        const payload = Buffer.from(parts[1], 'base64url').toString('utf8');
        return JSON.parse(payload);
    } catch {
        return null;
    }
}

export function middleware(req: NextRequest) {
    const { pathname } = req.nextUrl;

    // Allow public paths and Next.js internals
    if (
        PUBLIC_PATHS.includes(pathname) ||
        pathname.startsWith('/_next') ||
        pathname.startsWith('/api') ||
        pathname.includes('.')
    ) {
        return NextResponse.next();
    }

    const token = req.cookies.get('insurelead_token')?.value;

    // No token → redirect to login
    if (!token) {
        const loginUrl = req.nextUrl.clone();
        loginUrl.pathname = '/login';
        return NextResponse.redirect(loginUrl);
    }

    const payload = getTokenPayload(token);

    // Malformed token → redirect to login
    if (!payload?.role) {
        const loginUrl = req.nextUrl.clone();
        loginUrl.pathname = '/login';
        return NextResponse.redirect(loginUrl);
    }

    const role = payload.role;
    const allowedPrefixes = ROLE_PREFIXES[role] ?? [];

    // Check if current path is allowed for this role
    const isAllowed = allowedPrefixes.some((prefix) => pathname.startsWith(prefix));
    if (!isAllowed) {
        const home = req.nextUrl.clone();
        home.pathname = ROLE_HOME[role] ?? '/login';
        return NextResponse.redirect(home);
    }

    return NextResponse.next();
}

export const config = {
    matcher: [
        /*
         * Match all paths except:
         * - _next/static (static files)
         * - _next/image (image optimization)
         * - favicon.ico
         */
        '/((?!_next/static|_next/image|favicon.ico).*)',
    ],
};
